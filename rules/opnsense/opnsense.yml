groups:
    - name: OPNsenseExporter
      rules:
        - alert: OPNsenseFirewallStatusError
          expr: opnsense_firewall_status == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: OPNsense firewall status error (instance {{ $labels.opnsense_instance }})
            description: |-
                OPNsense firewall is reporting errors
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsensefirewallstatuserror/
        - alert: OPNsenseGatewayOffline
          expr: opnsense_gateways_status != 1
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: OPNsense gateway offline (instance {{ $labels.opnsense_instance }})
            description: |-
                Gateway {{ $labels.name }} ({{ $labels.address }}) is offline
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsensegatewayoffline/
        - alert: OPNsenseGatewayHighLatency
          expr: opnsense_gateways_rtt_milliseconds > 100
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: OPNsense gateway high latency (instance {{ $labels.opnsense_instance }})
            description: |-
                Gateway {{ $labels.name }} has high latency (> 100ms)
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsensegatewayhighlatency/
        - alert: OPNsenseGatewayPacketLoss
          expr: opnsense_gateways_loss_percentage > 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: OPNsense gateway packet loss (instance {{ $labels.opnsense_instance }})
            description: |-
                Gateway {{ $labels.name }} has packet loss (> 1%)
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsensegatewaypacketloss/
        - alert: OPNsenseInterfaceInputErrors
          expr: increase(opnsense_interfaces_input_errors_total[5m]) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: OPNsense interface input errors (instance {{ $labels.opnsense_instance }})
            description: |-
                Interface {{ $labels.interface }} ({{ $labels.device }}) has input errors
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsenseinterfaceinputerrors/
        - alert: OPNsenseInterfaceOutputErrors
          expr: increase(opnsense_interfaces_output_errors_total[5m]) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: OPNsense interface output errors (instance {{ $labels.opnsense_instance }})
            description: |-
                Interface {{ $labels.interface }} ({{ $labels.device }}) has output errors
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsenseinterfaceoutputerrors/
        - alert: OPNsenseHighBlockedPackets
          expr: rate(opnsense_firewall_in_ipv4_block_packets[5m]) > 1000
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: OPNsense high blocked packets (instance {{ $labels.opnsense_instance }})
            description: |-
                High rate of blocked IPv4 packets on interface {{ $labels.interface }} (> 1000/sec)
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsensehighblockedpackets/
        - alert: OPNsenseServiceDown
          expr: opnsense_services_status == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: OPNsense service down (instance {{ $labels.opnsense_instance }})
            description: |-
                Service {{ $labels.name }} ({{ $labels.description }}) is down
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsenseservicedown/
        - alert: OPNsenseExporterDown
          expr: opnsense_up == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: OPNsense exporter down (instance {{ $labels.opnsense_instance }})
            description: |-
                OPNsense exporter is not responding
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsenseexporterdown/
        - alert: OPNsenseFirmwareRebootRequired
          expr: opnsense_firmware_needs_reboot == 1
          for: 10m
          labels:
            severity: info
          annotations:
            summary: OPNsense firmware reboot required (instance {{ $labels.opnsense_instance }})
            description: |-
                OPNsense requires a reboot after firmware update
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsensefirmwarerebootrequired/
        - alert: OPNsenseWireGuardInterfaceDown
          expr: opnsense_wireguard_interfaces_status == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: OPNsense WireGuard interface down (instance {{ $labels.opnsense_instance }})
            description: |-
                WireGuard interface {{ $labels.device_name }} is down
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsensewireguardinterfacedown/
        - alert: OPNsenseWireGuardPeerStaleHandshake
          expr: (time() - opnsense_wireguard_peer_last_handshake_seconds) > 300
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: OPNsense WireGuard peer stale handshake (instance {{ $labels.opnsense_instance }})
            description: |-
                WireGuard peer {{ $labels.peer_name }} has not handshaked in > 5 minutes
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsensewireguardpeerstalehandshake/
        - alert: OPNsenseExporterEndpointErrors
          expr: increase(opnsense_exporter_endpoint_errors_total[5m]) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: OPNsense exporter endpoint errors (instance {{ $labels.opnsense_instance }})
            description: |-
                OPNsense exporter encountered errors fetching data from endpoint {{ $labels.endpoint }}
                  VALUE = {{ $value }}
                  LABELS = {{ $labels }}
            runbook: https://srerun.github.io/prometheus-alerts/runbooks/opnsense/opnsenseexporterendpointerrors/
